name: Ultimate IPTV Generator Full

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 4 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Prepare folders
        run: |
          mkdir -p public
          mkdir -p cache

      - name: Generate Ultimate IPTV Sources
        run: |
          node <<'JS'
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');

          const inputDir = path.join(__dirname, 'channels');
          const outputDir = path.join(__dirname, 'public');
          const cacheDir = path.join(__dirname, 'cache');
          const timeout = 5000;
          const concurrency = 20;

          const regions = {
            cn: ['CN','China','cctv'],
            hk: ['HK','Hong Kong'],
            tw: ['TW','Taiwan']
          };

          if (!fs.existsSync(outputDir)) fs.mkdirSync(outputDir);
          if (!fs.existsSync(cacheDir)) fs.mkdirSync(cacheDir);

          function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

          async function checkUrl(url){
            try{
              const resp = await axios.head(url,{timeout});
              return resp.status>=200 && resp.status<400;
            }catch{return false;}
          }

          function loadCache(region){
            const f = path.join(cacheDir, `${region}-cache.json`);
            if(fs.existsSync(f)) return JSON.parse(fs.readFileSync(f,'utf8'));
            return {};
          }

          function saveCache(region, cache){
            fs.writeFileSync(path.join(cacheDir,`${region}-cache.json`),JSON.stringify(cache,null,2),'utf8');
          }

          async function processRegion(key, keywords){
            let m3uLines=['#EXTM3U'];
            let jsonList=[];
            let failedList=[];
            const cache = loadCache(key);
            const files = fs.readdirSync(inputDir).filter(f=>f.endsWith('.m3u'));

            for(const file of files){
              const content = fs.readFileSync(path.join(inputDir,file),'utf8');
              const lines = content.split('\n');
              const tasks=[];
              for(let i=0;i<lines.length;i++){
                const line=lines[i].trim();
                if(line.startsWith('#EXTINF:')){
                  const matched=keywords.some(k=>line.toLowerCase().includes(k.toLowerCase()));
                  if(!matched) continue;
                  const urlLine=lines[i+1]?lines[i+1].trim():'';
                  if(!urlLine) continue;

                  tasks.push(async ()=>{
                    let ok;
                    // 使用缓存
                    if(cache[urlLine] && (Date.now()-cache[urlLine].lastChecked<24*60*60*1000)){
                      ok=cache[urlLine].status;
                    } else {
                      ok=await checkUrl(urlLine);
                      cache[urlLine]={status:ok,lastChecked:Date.now()};
                    }

                    if(!ok){
                      failedList.push(urlLine);
                      return;
                    }

                    if(jsonList.some(j=>j.url===urlLine)) return;

                    m3uLines.push(line);
                    m3uLines.push(urlLine);

                    const metaMatch=line.match(/tvg-id="(.*?)"/);
                    const tvgId=metaMatch?metaMatch[1]:'';
                    const nameMatch=line.match(/,(.*)$/);
                    const name=nameMatch?nameMatch[1].trim():'';
                    const logoMatch=line.match(/tvg-logo="(.*?)"/);
                    const logo=logoMatch?logoMatch[1]:'';
                    const groupMatch=line.match(/group-title="(.*?)"/);
                    const group=groupMatch?groupMatch[1]:key.toUpperCase();

                    // 自动替换备用源 (可自定义)
                    const urlVariants=[urlLine]; // 可在此添加镜像源
                    let finalUrl=urlVariants[0];
                    for(const altUrl of urlVariants){
                      const altOk=await checkUrl(altUrl);
                      if(altOk){finalUrl=altUrl; break;}
                    }

                    jsonList.push({name,url:finalUrl,"tvg-id":tvgId,"tvg-logo":logo,"group-title":group,"lastChecked":cache[urlLine].lastChecked});
                  });
                }
              }

              for(let i=0;i<tasks.length;i+=concurrency){
                await Promise.all(tasks.slice(i,i+concurrency).map(fn=>fn()));
              }
            }

            // 输出
            fs.writeFileSync(path.join(outputDir,`${key}.m3u`),m3uLines.join('\n'),'utf8');
            fs.writeFileSync(path.join(outputDir,`${key}.json`),JSON.stringify(jsonList,null,2),'utf8');

            const grouped={};
            jsonList.forEach(item=>{
              const g=item['group-title']||'Others';
              if(!grouped[g]) grouped[g]=[];
              grouped[g].push(item);
            });
            fs.writeFileSync(path.join(outputDir,`${key}-grouped.json`),JSON.stringify(grouped,null,2),'utf8');
            if(failedList.length>0){
              fs.writeFileSync(path.join(outputDir,`${key}-failed.txt`),failedList.join('\n'),'utf8');
            }

            saveCache(key,cache);
            console.log(`Region ${key}: ${jsonList.length} valid channels, ${failedList.length} failed`);
          }

          (async ()=>{
            for(const [key,keywords] of Object.entries(regions)){
              await processRegion(key,keywords);
              await sleep(500);
            }
          })();
          JS

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/ cache/
          git commit -m "Auto-generate ultimate IPTV files [skip ci]" || echo "No changes"
          git push
